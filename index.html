<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Voice Uplink â€¢ Secure Channel</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />

    <!-- Jitsi Meet API -->
    <script src='https://meet.jit.si/external_api.js'></script>

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;700;800&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        display: ['Outfit', 'sans-serif'],
                    },
                    colors: {
                        slate: {
                            850: '#151e2e',
                            950: '#020617', // The specific deep midnight blue
                        },
                        brand: {
                            400: '#38bdf8', // Sky blue for voice theme
                            500: '#0ea5e9',
                            600: '#0284c7',
                        }
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'float': 'float 6s ease-in-out infinite',
                        'slide-up': 'slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'fade-in': 'fadeIn 0.5s ease-out forwards',
                        'ripple': 'ripple 1.5s cubic-bezier(0, 0.2, 0.8, 1) infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        },
                        slideUp: {
                            'from': { transform: 'translateY(20px)', opacity: '0' },
                            'to': { transform: 'translateY(0)', opacity: '1' },
                        },
                        fadeIn: {
                            'from': { opacity: '0' },
                            'to': { opacity: '1' },
                        },
                        ripple: {
                            '0%': { transform: 'scale(1)', opacity: '0.5' },
                            '100%': { transform: 'scale(2)', opacity: '0' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Core Locking Styles */
        html, body {
            position: fixed;
            inset: 0;
            overflow: hidden;
            background-color: #020617;
            color: #f8fafc;
            -webkit-tap-highlight-color: transparent;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
            font-family: 'Inter', sans-serif;
        }

        /* Glassmorphism Classes */
        .glass-panel {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.2);
        }

        .glass-panel-lighter {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* Ambient Blobs */
        .blob {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.4;
            z-index: 0;
            animation: blob-bounce 10s infinite ease-in-out;
        }

        @keyframes blob-bounce {
            0%, 100% { transform: translate(0, 0) scale(1); }
            33% { transform: translate(30px, -50px) scale(1.1); }
            66% { transform: translate(-20px, 20px) scale(0.9); }
        }

        /* Utility Hide Scrollbar */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Jitsi Iframe Hider */
        #jitsi-container iframe {
            display: none !important; 
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const CustomSelect = ({ options, value, onChange, placeholder, icon }) => {
            const [isOpen, setIsOpen] = useState(false);
            const containerRef = useRef(null);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (containerRef.current && !containerRef.current.contains(event.target)) {
                        setIsOpen(false);
                    }
                };
                document.addEventListener('mousedown', handleClickOutside);
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, []);

            const selectedLabel = options.find(opt => opt.deviceId === value)?.label || placeholder;

            return (
                <div className="relative w-full" ref={containerRef}>
                    <button 
                        onClick={() => setIsOpen(!isOpen)}
                        className="w-full glass-panel-lighter rounded-xl p-4 flex items-center justify-between text-left transition-all active:scale-[0.98] group"
                    >
                        <div className="flex items-center gap-3 overflow-hidden">
                            <i className={`fa-solid ${icon} text-brand-400 opacity-70 group-hover:opacity-100 transition-opacity`}></i>
                            <span className="truncate text-sm font-semibold text-white/90">{selectedLabel}</span>
                        </div>
                        <i className={`fa-solid fa-chevron-down text-xs text-white/30 transition-transform duration-300 ${isOpen ? 'rotate-180' : ''}`}></i>
                    </button>

                    {isOpen && (
                        <div className="absolute top-full left-0 right-0 mt-2 glass-panel rounded-xl overflow-hidden z-50 animate-fade-in max-h-48 overflow-y-auto no-scrollbar">
                            {options.length > 0 ? options.map((opt) => (
                                <button
                                    key={opt.deviceId}
                                    onClick={() => {
                                        onChange(opt.deviceId);
                                        setIsOpen(false);
                                    }}
                                    className={`w-full text-left p-4 text-sm font-medium border-b border-white/5 last:border-0 hover:bg-white/10 transition-colors flex items-center gap-2 ${value === opt.deviceId ? 'text-brand-400 bg-brand-400/10' : 'text-white/70'}`}
                                >
                                    {value === opt.deviceId && <i className="fa-solid fa-check text-xs"></i>}
                                    <span className="truncate">{opt.label}</span>
                                </button>
                            )) : (
                                <div className="p-4 text-center text-xs text-white/40">No devices found</div>
                            )}
                        </div>
                    )}
                </div>
            );
        };

        const Modal = ({ children, title, icon }) => (
            <div className="fixed inset-0 z-50 flex items-center justify-center p-6 animate-fade-in">
                <div className="absolute inset-0 bg-black/80 backdrop-blur-md"></div>
                <div className="relative w-full max-w-sm glass-panel rounded-[2rem] p-8 animate-slide-up flex flex-col items-center text-center shadow-2xl shadow-brand-900/20">
                    {icon && (
                        <div className="w-16 h-16 rounded-full bg-brand-500/10 flex items-center justify-center mb-6 ring-1 ring-brand-500/30">
                            <i className={`fa-solid ${icon} text-2xl text-brand-400`}></i>
                        </div>
                    )}
                    {title && <h2 className="text-2xl font-display font-bold text-white mb-2">{title}</h2>}
                    {children}
                </div>
            </div>
        );

        const App = () => {
            const [step, setStep] = useState('landing');
            const [roomName, setRoomName] = useState('');
            const [userName, setUserName] = useState('');
            
            const [micList, setMicList] = useState([]);
            const [selectedMic, setSelectedMic] = useState('');
            const [permissionGranted, setPermissionGranted] = useState(false);
            
            const [jitsiApi, setJitsiApi] = useState(null);
            const [isMuted, setIsMuted] = useState(false);
            const [participants, setParticipants] = useState(1);
            const [volumeLevel, setVolumeLevel] = useState(0);

            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                const roomParam = params.get('room');
                if (roomParam) {
                    // Sanitize and normalize room name from URL
                    const sanitized = roomParam.trim().replace(/[^a-zA-Z0-9]/g, '').toUpperCase();
                    setRoomName(sanitized);
                } else {
                    const randomId = Math.random().toString(36).substring(2, 8).toUpperCase();
                    setRoomName(randomId);
                }

                const savedName = localStorage.getItem('uplink_username');
                if (savedName) setUserName(savedName);
            }, []);

            useEffect(() => {
                if (step === 'call' && !isMuted) {
                    const interval = setInterval(() => {
                        setVolumeLevel(Math.random() * 100);
                    }, 100);
                    return () => clearInterval(interval);
                } else {
                    setVolumeLevel(0);
                }
            }, [step, isMuted]);

            const getPermissions = async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    setPermissionGranted(true);
                    
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    const audioInputs = devices.filter(device => device.kind === 'audioinput');
                    
                    const formattedMics = audioInputs.map(d => ({
                        deviceId: d.deviceId,
                        label: d.label || `Microphone ${d.deviceId.slice(0, 5)}...`
                    }));
                    
                    setMicList(formattedMics);
                    if (formattedMics.length > 0) setSelectedMic(formattedMics[0].deviceId);
                    
                    stream.getTracks().forEach(track => track.stop());
                    
                } catch (error) {
                    console.error("Permission denied", error);
                    alert("Microphone access is required to use the uplink.");
                }
            };

            const startCall = () => {
                if (!userName.trim()) {
                    alert("Codename required.");
                    return;
                }
                localStorage.setItem('uplink_username', userName);
                setStep('call');
            };

            useEffect(() => {
                if (step === 'call' && !jitsiApi) {
                    // CRITICAL FIX: Sanitize input and force lowercase for Jitsi backend naming consistency
                    // This ensures "Room1" and "room1" land in the same Jitsi channel
                    const sanitizedRoom = roomName.trim().replace(/[^a-zA-Z0-9]/g, '').toLowerCase() || "lobby";
                    
                    const domain = 'meet.jit.si';
                    const options = {
                        roomName: `UplinkSecure_${sanitizedRoom}`,
                        width: '100%',
                        height: '100%',
                        parentNode: document.getElementById('jitsi-container'),
                        configOverwrite: {
                            startWithVideoMuted: true,
                            startWithAudioMuted: false,
                            disableDeepLinking: true,
                            prejoinPageEnabled: false,
                            p2p: { enabled: true },
                            audioOnly: true,
                        },
                        interfaceConfigOverwrite: {
                            TOOLBAR_BUTTONS: [],
                            FILM_STRIP_MAX_HEIGHT: 0,
                            SHOW_JITSI_WATERMARK: false,
                            SHOW_WATERMARK_FOR_GUESTS: false,
                        },
                        userInfo: {
                            displayName: userName
                        }
                    };

                    const api = new window.JitsiMeetExternalAPI(domain, options);
                    
                    api.addEventListeners({
                        videoConferenceJoined: () => {
                            if (selectedMic) {
                                api.setAudioInputDevice(selectedMic);
                            }
                            // Initial participant count
                            setParticipants(api.getNumberOfParticipants());
                        },
                        audioMuteStatusChanged: (e) => {
                            setIsMuted(e.muted);
                        },
                        participantJoined: () => {
                            setParticipants(api.getNumberOfParticipants());
                        },
                        participantLeft: () => {
                            setParticipants(api.getNumberOfParticipants());
                        },
                    });

                    setJitsiApi(api);
                }
            }, [step]);

            const toggleMute = () => {
                if (jitsiApi) {
                    jitsiApi.executeCommand('toggleAudio');
                }
            };

            const leaveCall = () => {
                if (jitsiApi) {
                    jitsiApi.dispose();
                    setJitsiApi(null);
                }
                setStep('landing');
            };

            const shareLink = () => {
                const url = `${window.location.origin}${window.location.pathname}?room=${roomName}`;
                navigator.clipboard.writeText(url).then(() => {
                    alert("Secure link copied to clipboard. Share this with your partner.");
                });
            };

            return (
                <div className="w-full h-full relative z-10 font-sans">
                    <div className="absolute inset-0 pointer-events-none">
                        <div className="blob bg-brand-600/20 top-[-20%] left-[-20%] w-[80%] h-[80%]"></div>
                        <div className="blob bg-cyan-600/20 bottom-[-20%] right-[-20%] w-[80%] h-[80%] animation-delay-2000"></div>
                        <div className="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] opacity-[0.03]"></div>
                    </div>

                    <div id="jitsi-container" key={roomName} className="absolute top-0 left-0 w-px h-px opacity-0 pointer-events-none"></div>

                    {step === 'landing' && (
                        <div className="flex flex-col h-full p-6 animate-fade-in">
                            <div className="flex-1 flex flex-col items-center justify-center max-w-sm mx-auto w-full">
                                <div className="w-24 h-24 rounded-full bg-brand-500/10 flex items-center justify-center mb-8 ring-1 ring-brand-500/30 shadow-[0_0_50px_rgba(14,165,233,0.2)] animate-float">
                                    <i className="fa-solid fa-tower-broadcast text-4xl text-brand-400"></i>
                                </div>
                                
                                <h1 className="text-5xl font-display font-black text-transparent bg-clip-text bg-gradient-to-br from-white via-white to-white/50 mb-2 drop-shadow-lg tracking-tight">
                                    UPLINK
                                </h1>
                                <p className="text-white/40 font-medium tracking-widest text-xs uppercase mb-12">Secure Voice Channel</p>

                                <div className="w-full glass-panel rounded-[2rem] p-6 space-y-4">
                                    <div className="bg-slate-950/50 rounded-xl border border-white/5 flex items-center px-4 transition-colors focus-within:border-brand-500/50">
                                        <i className="fa-solid fa-hashtag text-white/30 text-sm"></i>
                                        <input 
                                            type="text" 
                                            value={roomName}
                                            onChange={(e) => setRoomName(e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, ''))}
                                            placeholder="CHANNEL ID"
                                            className="w-full bg-transparent border-none outline-none py-4 px-3 text-white font-mono tracking-widest text-sm placeholder:text-white/20 uppercase"
                                        />
                                    </div>

                                    <div className="bg-slate-950/50 rounded-xl border border-white/5 flex items-center px-4 transition-colors focus-within:border-brand-500/50">
                                        <i className="fa-solid fa-user-astronaut text-white/30 text-sm"></i>
                                        <input 
                                            type="text" 
                                            value={userName}
                                            onChange={(e) => setUserName(e.target.value)}
                                            placeholder="CODENAME"
                                            className="w-full bg-transparent border-none outline-none py-4 px-3 text-white font-bold text-sm placeholder:text-white/20"
                                        />
                                    </div>
                                    
                                    <button 
                                        onClick={() => setStep('permissions')}
                                        className="w-full bg-white text-slate-950 font-display font-bold text-lg py-4 rounded-xl shadow-[0_0_30px_rgba(255,255,255,0.1)] hover:shadow-[0_0_40px_rgba(255,255,255,0.2)] active:scale-[0.98] transition-all flex items-center justify-center gap-2 mt-4"
                                    >
                                        INITIALIZE <i className="fa-solid fa-chevron-right text-xs"></i>
                                    </button>
                                </div>

                                <button onClick={shareLink} className="mt-8 text-white/40 text-xs font-bold uppercase tracking-widest hover:text-white transition-colors flex items-center gap-2">
                                    <i className="fa-solid fa-share-nodes"></i> Share Frequency
                                </button>
                            </div>
                        </div>
                    )}

                    {step === 'permissions' && (
                        <Modal title="Hardware Check" icon="microchip">
                            <p className="text-white/60 text-sm mb-8 leading-relaxed">
                                To establish a secure voice uplink, we need access to your audio input hardware.
                            </p>

                            {!permissionGranted ? (
                                <button 
                                    onClick={getPermissions}
                                    className="w-full bg-brand-600 text-white font-display font-bold text-lg py-4 rounded-xl shadow-[0_0_30px_rgba(14,165,233,0.3)] active:scale-[0.98] transition-all mb-4"
                                >
                                    GRANT ACCESS
                                </button>
                            ) : (
                                <div className="w-full space-y-4 animate-fade-in">
                                    <div className="text-left">
                                        <label className="text-xs text-brand-400 font-bold uppercase tracking-wider ml-1 mb-2 block">Select Input Device</label>
                                        <CustomSelect 
                                            options={micList} 
                                            value={selectedMic} 
                                            onChange={setSelectedMic} 
                                            placeholder="Choose Microphone"
                                            icon="fa-microphone-lines"
                                        />
                                    </div>

                                    <button 
                                        onClick={startCall}
                                        className="w-full bg-white text-slate-950 font-display font-bold text-lg py-4 rounded-xl shadow-[0_0_30px_rgba(255,255,255,0.1)] active:scale-[0.98] transition-all mt-6"
                                    >
                                        ESTABLISH LINK
                                    </button>
                                </div>
                            )}

                            {!permissionGranted && (
                                <button onClick={() => setStep('landing')} className="text-white/30 text-sm font-bold mt-4 hover:text-white">
                                    Cancel
                                </button>
                            )}
                        </Modal>
                    )}

                    {step === 'call' && (
                        <div className="flex flex-col h-full p-6 animate-slide-up relative">
                            <div className="glass-panel-lighter rounded-full px-6 py-3 mx-auto flex items-center gap-4">
                                <div className="flex items-center gap-2">
                                    <div className="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                                    <span className="text-xs font-mono text-green-400 tracking-widest">LIVE</span>
                                </div>
                                <div className="w-px h-3 bg-white/10"></div>
                                <span className="text-xs font-bold text-white/60 tracking-wider">CH: {roomName}</span>
                                <div className="w-px h-3 bg-white/10"></div>
                                <div className="flex items-center gap-1.5">
                                    <i className="fa-solid fa-users text-[10px] text-white/40"></i>
                                    <span className="text-xs font-mono text-white/60">{participants}</span>
                                </div>
                            </div>

                            <div className="flex-1 flex flex-col items-center justify-center relative">
                                <div className={`absolute w-64 h-64 rounded-full border border-brand-500/20 transition-all duration-100 ease-out ${isMuted ? 'scale-90 opacity-20' : 'scale-100 opacity-100'}`} style={{ transform: `scale(${1 + volumeLevel/300})` }}></div>
                                <div className={`absolute w-48 h-48 rounded-full border border-brand-500/40 transition-all duration-100 ease-out ${isMuted ? 'scale-90 opacity-20' : 'scale-100 opacity-100'}`} style={{ transform: `scale(${1 + volumeLevel/200})` }}></div>
                                
                                <div className={`w-32 h-32 rounded-full flex items-center justify-center transition-all duration-500 ${isMuted ? 'bg-slate-800 shadow-none' : 'bg-gradient-to-br from-brand-400 to-brand-600 shadow-[0_0_60px_rgba(56,189,248,0.4)]'}`}>
                                    <i className={`fa-solid ${isMuted ? 'fa-microphone-slash text-white/20' : 'fa-microphone text-white'} text-3xl transition-all duration-300`}></i>
                                    
                                    {!isMuted && (
                                        <div className="absolute inset-0 rounded-full border border-brand-200 opacity-0 animate-ripple"></div>
                                    )}
                                </div>

                                <div className="mt-8 text-center">
                                    <h2 className="text-2xl font-display font-bold text-white mb-1">{userName}</h2>
                                    <p className="text-brand-400/60 text-xs font-mono tracking-widest uppercase">
                                        {isMuted ? 'TRANSMISSION MUTED' : 'TRANSMITTING AUDIO'}
                                    </p>
                                </div>
                            </div>

                            <div className="w-full max-w-sm mx-auto glass-panel rounded-[2.5rem] p-4 flex items-center justify-between gap-4">
                                <button 
                                    onClick={shareLink}
                                    className="w-14 h-14 rounded-full bg-white/5 hover:bg-white/10 flex items-center justify-center text-white/50 hover:text-white transition-all active:scale-90"
                                >
                                    <i className="fa-solid fa-share-nodes"></i>
                                </button>

                                <button 
                                    onClick={toggleMute}
                                    className={`flex-1 h-20 rounded-[2rem] flex items-center justify-center gap-3 text-xl font-bold transition-all active:scale-95 shadow-lg ${isMuted ? 'bg-white text-slate-950 shadow-white/10' : 'glass-panel border-brand-500/30 text-white shadow-brand-900/20'}`}
                                >
                                    <i className={`fa-solid ${isMuted ? 'fa-microphone-slash' : 'fa-microphone'}`}></i>
                                    {isMuted ? 'UNMUTE' : 'MUTE'}
                                </button>

                                <button 
                                    onClick={leaveCall}
                                    className="w-20 h-20 rounded-full bg-red-500/20 hover:bg-red-500 text-red-500 hover:text-white border border-red-500/30 flex items-center justify-center transition-all active:scale-90 shadow-[0_0_30_rgba(239,68,68,0.1)]"
                                >
                                    <i className="fa-solid fa-phone-slash text-xl"></i>
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
